<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="This is the core of the Reax lib.">

<title>reax - core</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="reax - core">
<meta property="og:description" content="This is the core of the `Reax` lib.">
<meta property="og:site-name" content="reax">
<meta name="twitter:title" content="reax - core">
<meta name="twitter:description" content="This is the core of the `Reax` lib.">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">reax</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="dropdown-header">
 <span class="menu-text">Experimental Haiku/JAX training package</span></li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/fredguth/reax"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">core</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Welcome</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">reax</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">API</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./core.html" class="sidebar-item-text sidebar-link active">core</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data.html" class="sidebar-item-text sidebar-link">data</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./stores.html" class="sidebar-item-text sidebar-link">stores</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./utils.html" class="sidebar-item-text sidebar-link">utils</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#setup" id="toc-setup" class="nav-link active" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#model" id="toc-model" class="nav-link" data-scroll-target="#model">Model</a>
  <ul class="collapse">
  <li><a href="#model-1" id="toc-model-1" class="nav-link" data-scroll-target="#model-1">Model</a></li>
  <li><a href="#modelstore" id="toc-modelstore" class="nav-link" data-scroll-target="#modelstore">ModelStore</a></li>
  <li><a href="#optimizer-1" id="toc-optimizer-1" class="nav-link" data-scroll-target="#optimizer-1">Optimizer</a></li>
  </ul></li>
  <li><a href="#training" id="toc-training" class="nav-link" data-scroll-target="#training">Training</a>
  <ul class="collapse">
  <li><a href="#learner-1" id="toc-learner-1" class="nav-link" data-scroll-target="#learner-1">Learner</a></li>
  <li><a href="#trainingstate" id="toc-trainingstate" class="nav-link" data-scroll-target="#trainingstate">TrainingState</a></li>
  <li><a href="#training-store" id="toc-training-store" class="nav-link" data-scroll-target="#training-store">Training Store</a></li>
  <li><a href="#trainingstore" id="toc-trainingstore" class="nav-link" data-scroll-target="#trainingstore">TrainingStore</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content column-body" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">core</h1>
</div>

<div>
  <div class="description">
    This is the core of the <code>Reax</code> lib.
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<section id="data" class="level4">
<h4 class="anchored" data-anchor-id="data">Data</h4>
<p>As in <code>miniai</code>, we wil be using the <code>FashionMnist</code> Dataset for demonstration. <code>Reax</code> is not intended to be a complete library, the <code>data</code> module is just a copy from <a href="">miniai</a> to make it work.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="5">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torchvision</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torchvision.transforms <span class="im">as</span> transforms</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> reax.data <span class="im">import</span> DataLoaders, Batch, Tensor</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="6">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>XMEAN,XSTD, BATCH_SIZE, NUM_CLASSES <span class="op">=</span> <span class="fl">0.28</span>,<span class="fl">0.35</span>, <span class="dv">500</span>, <span class="dv">10</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> transforms.Compose([transforms.PILToTensor(), </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>                          transforms.Lambda(<span class="kw">lambda</span> x: x<span class="op">/</span><span class="dv">255</span>), transforms.Normalize(XMEAN, XSTD), </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>                          transforms.Lambda(<span class="kw">lambda</span> x: torch.flatten(x))])</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>ds <span class="op">=</span> partial(torchvision.datasets.FashionMNIST,root<span class="op">=</span><span class="st">"data"</span>,download<span class="op">=</span><span class="va">True</span>, transform <span class="op">=</span> tfm)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>train_ds, valid_ds <span class="op">=</span> ds(train<span class="op">=</span><span class="va">True</span>), ds(train<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>tdl <span class="op">=</span> DataLoader(train_ds, batch_size<span class="op">=</span>BATCH_SIZE)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>vdl <span class="op">=</span> DataLoader(valid_ds, batch_size<span class="op">=</span>BATCH_SIZE)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> DataLoaders(tdl, vdl)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>batch <span class="op">=</span> Batch(<span class="op">*</span><span class="bu">map</span>(jnp.array, <span class="bu">next</span>(<span class="bu">iter</span>(dls.train))))</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>batch</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>Batch(input=Array[500, 784] n=392000 x∈[-0.800, 2.057] μ=0.011 σ=1.006 gpu:0, target=Array[500] i32 x∈[0, 9] μ=4.402 σ=2.838 gpu:0)</code></pre>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Have you noticed how tensors are printed? This is <a href="https://xl0.github.io/lovely-jax/">lovely-jax</a>, the wonderful library that makes the JAX array representation more friendly.</p>
</div>
</div>
</section>
</section>
<section id="model" class="level2">
<h2 class="anchored" data-anchor-id="model">Model</h2>
<p>The basic <a href="https://dm-haiku.readthedocs.io/">Haiku</a> object to represent a model is a <a href="https://dm-haiku.readthedocs.io/en/latest/api.html#transformedwithstate">TransformedWithState</a>. It represents a <code>function</code> or <code>module</code> that has been transformed by a <code>hk.transform</code> function. Here we are using <code>hk.transform_with_state</code> which is the superset of the transform functions.</p>
<p>State in the <code>Haiku</code> lingo means everything that make your original <code>Callable</code> not a pure function. It is the context or state. Somoe common <code>DNN</code> modules like <code>batch_norm</code>can keep some <code>state</code> to perform its work. <code>State</code>, <code>Buffers</code> and <code>Context</code> are common names for this.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="7">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> forward(x:jnp.array) <span class="op">-&gt;</span>jnp.ndarray:</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> hk.nets.MLP(output_sizes<span class="op">=</span>[<span class="dv">50</span>,NUM_CLASSES])(x) <span class="co"># todo: remove NUM_CLASSES dependency</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>network <span class="op">=</span> hk.transform_with_state(forward)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(network)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>haiku._src.transform.TransformedWithState</code></pre>
</div>
</div>
<section id="model-class" class="level4">
<h4 class="anchored" data-anchor-id="model-class">Model class</h4>
<p>In <code>Reax</code>, a <a href="https://fredguth.github.io/reax/core.html#model"><code>Model</code></a> is an immutable object. <a href="https://jax.readthedocs.io/en/latest/pytrees.html">PyTrees</a> are JAX datastructures.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="9">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Model(NamedTuple):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    params: PyTree <span class="co"># the models parameters, weights and biases</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    state: PyTree  <span class="co"># the model auxiliary state, e.g. batchnorm buffers</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">apply</span>: ApplyFn <span class="co"># the model forward pass function</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    input_shape: Tuple[<span class="bu">int</span>, ...] <span class="co"># the shape of the input, used to infer the model output shape</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    rng <span class="op">=</span> hk.PRNGSequence(<span class="dv">42</span>) <span class="co"># random number generator</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> from_haiku(</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        transformed: hk.TransformedWithState,       <span class="co"># transformed haiku model</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        x: Tensor                                   <span class="co"># example input (e.g. batch.input)</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">''' Create a Model from a Haiku Transformed object and an example input.'''</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        init, <span class="bu">apply</span> <span class="op">=</span> transformed</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        params, state <span class="op">=</span> jax.jit(init)(<span class="bu">next</span>(Model.rng), x)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Model(params<span class="op">=</span>params, state<span class="op">=</span>state, <span class="bu">apply</span><span class="op">=</span><span class="bu">apply</span>, input_shape<span class="op">=</span>x.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<p><a href="https://github.com/fredguth/reax/blob/main/reax/core.py#L29" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="model-1" class="level3">
<h3 class="anchored" data-anchor-id="model-1">Model</h3>
<blockquote class="blockquote">
<pre><code> Model (params:Union[jax.Array,numpy.ndarray,Tuple[ForwardRef('PyTree'),..
        .],List[ForwardRef('PyTree')],Dict[Hashable,ForwardRef('PyTree')],
        Mapping[str,Mapping[str,jax.Array]],Iterable[ForwardRef('ArrayTree
        ')],Mapping[Any,ForwardRef('ArrayTree')],NoneType], state:Union[ja
        x.Array,numpy.ndarray,Tuple[ForwardRef('PyTree'),...],List[Forward
        Ref('PyTree')],Dict[Hashable,ForwardRef('PyTree')],Mapping[str,Map
        ping[str,jax.Array]],Iterable[ForwardRef('ArrayTree')],Mapping[Any
        ,ForwardRef('ArrayTree')],NoneType], apply:Callable[...,Tuple[Unio
        n[jax.Array,numpy.ndarray],Union[jax.Array,numpy.ndarray,Tuple[For
        wardRef('PyTree'),...],List[ForwardRef('PyTree')],Dict[Hashable,Fo
        rwardRef('PyTree')],Mapping[str,Mapping[str,jax.Array]],Iterable[F
        orwardRef('ArrayTree')],Mapping[Any,ForwardRef('ArrayTree')],NoneT
        ype]]], input_shape:Tuple[int,...])</code></pre>
</blockquote>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="10">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> Model.from_haiku(transformed<span class="op">=</span>network, x<span class="op">=</span>batch.<span class="bu">input</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<div class="ansi-escaped-output">
<pre>Model(params={'mlp/~/linear_0': {'b': Array[50] <span style="color:rgb(127,127,127)">all_zeros</span> gpu:0, 'w': Array[784, 50] n=39200 x∈[-0.071, 0.071] μ=0.000 σ=0.032 gpu:0}, 'mlp/~/linear_1': {'b': Array[10] <span style="color:rgb(127,127,127)">all_zeros</span> gpu:0 [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.], 'w': Array[50, 10] n=500 x∈[-0.276, 0.270] μ=-0.001 σ=0.121 gpu:0}}, state={}, apply=&lt;function transform_with_state.&lt;locals&gt;.apply_fn at 0x7f514c0ed280&gt;, input_shape=(500, 784))</pre>
</div>
</div>
</div>
<p>Let’s keep us sane and improve the model representation.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> Model.from_haiku(transformed<span class="op">=</span>network, x<span class="op">=</span>batch.<span class="bu">input</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>Model:
+---------------------------------------------+---------+
| Params                                      | State   |
+=============================================+=========+
| mlp/~/linear_0:                             | {}      |
|   b: all_zeros                              |         |
|   w: x∈[-0.071, 0.071] μ=-9.844e-05 σ=0.032 |         |
| mlp/~/linear_1:                             |         |
|   b: all_zeros                              |         |
|   w: x∈[-0.275, 0.279] μ=-0.002 σ=0.123     |         |
+---------------------------------------------+---------+</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+--------------+-------------------------+-----------------+-------------+---------------+
| Input        | Module                  | Module params   | Output      |   Param count |
+==============+=========================+=================+=============+===============+
| f32[500,784] | mlp (MLP)               |                 | f32[500,10] |        39,760 |
+--------------+-------------------------+-----------------+-------------+---------------+
| f32[500,784] | mlp/~/linear_0 (Linear) | w: f32[784,50]  | f32[500,50] |        39,250 |
|              |  └ mlp (MLP)            | b: f32[50]      |             |               |
+--------------+-------------------------+-----------------+-------------+---------------+
| f32[500,50]  | mlp/~/linear_1 (Linear) | w: f32[50,10]   | f32[500,10] |           510 |
|              |  └ mlp (MLP)            | b: f32[10]      |             |               |
+--------------+-------------------------+-----------------+-------------+---------------+
+---------------------------------------------+---------+
| Params                                      | State   |
+=============================================+=========+
| mlp/~/linear_0:                             | {}      |
|   b: all_zeros                              |         |
|   w: x∈[-0.071, 0.071] μ=-9.844e-05 σ=0.032 |         |
| mlp/~/linear_1:                             |         |
|   b: all_zeros                              |         |
|   w: x∈[-0.275, 0.279] μ=-0.002 σ=0.123     |         |
+---------------------------------------------+---------+</code></pre>
</div>
</div>
<section id="model-reactivity-model-store" class="level4">
<h4 class="anchored" data-anchor-id="model-reactivity-model-store">Model Reactivity (Model Store)</h4>
<p>Ok, now we will start to play with reactivity. In <code>fastai</code> (also in Keras, vanilla PyTorch, etc) there is the concept of <code>Callbacks</code>. It is the way to be notified when something of interest happens.</p>
<blockquote class="blockquote">
<p>Don’t nudge me, let me <strong>call you back</strong> when I have something for you!</p>
</blockquote>
<p>In general, you will need a callback only during training, after all, it is when your <code>things</code> change. The model, the hyperparameters, the metrics, etc.</p>
<p>The <strong>fastai/miniai</strong> <a href="https://fredguth.github.io/reax/core.html#learner"><code>Learner</code></a> is an <code>Observable</code> and you can hold multiple callbacks. Every callback keep its state in the Learner object. You can have callbacks for metrics, for logging and saving the training process… callbacks that depend on other callbacks! That is why there is that … shall I say… <strong>ugly</strong> <code>order</code> property in the <code>Callback</code>class.</p>
<p><code>Reax</code> is just an experiment on how to handle this reactivity in another way. Maybe it will prove itself too bloated… or not. I decided to do it in <code>JAX/Haiku</code> to force a <code>functional programming</code> perspective.</p>
<p>The basic abstraction in <code>Reax</code> are <code>stores</code>, observables that hold any value. We could have used [RxPy] which is an incredible package. But its superpowers may be too much for what we need. That is why I took inspiration from the <code>Svelte</code> JS framework to create <code>stores</code> (it became its own package, <a href="https://fredguth.github.io/sveltish">Sveltish</a>).</p>
<p>A <a href="https://fredguth.github.io/reax/core.html#modelstore"><code>ModelStore</code></a> is just a <a href="https://fredguth.github.io/reax/stores.html#writable"><code>Writable</code></a> store that holds values of type <a href="https://fredguth.github.io/reax/core.html#model"><code>Model</code></a>.</p>
<hr>
<p><a href="https://github.com/fredguth/reax/blob/main/reax/core.py#L72" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
</section>
<section id="modelstore" class="level3">
<h3 class="anchored" data-anchor-id="modelstore">ModelStore</h3>
<blockquote class="blockquote">
<pre><code> ModelStore (initial_value:__main__.Model)</code></pre>
</blockquote>
<p>A Model store. Custom Writable store</p>
<table class="table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>initial_value</td>
<td>Model</td>
<td>Initial value of the store</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>None</strong></td>
<td></td>
</tr>
</tbody>
</table>
<section id="improving-the-modelstore-representation" class="level4">
<h4 class="anchored" data-anchor-id="improving-the-modelstore-representation">Improving the ModelStore representation</h4>
<p>We also may improve its representation.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="20">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>ms <span class="op">=</span> ModelStore(m)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>ms</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>ModelStore:
+---------------------------------------------+---------+-------------+
| Params                                      | State   | Callbacks   |
+=============================================+=========+=============+
| mlp/~/linear_0:                             | {}      | []          |
|   b: all_zeros                              |         |             |
|   w: x∈[-0.071, 0.071] μ=-9.844e-05 σ=0.032 |         |             |
| mlp/~/linear_1:                             |         |             |
|   b: all_zeros                              |         |             |
|   w: x∈[-0.275, 0.279] μ=-0.002 σ=0.123     |         |             |
+---------------------------------------------+---------+-------------+</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="22">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ms)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+--------------+-------------------------+-----------------+-------------+---------------+
| Input        | Module                  | Module params   | Output      |   Param count |
+==============+=========================+=================+=============+===============+
| f32[500,784] | mlp (MLP)               |                 | f32[500,10] |        39,760 |
+--------------+-------------------------+-----------------+-------------+---------------+
| f32[500,784] | mlp/~/linear_0 (Linear) | w: f32[784,50]  | f32[500,50] |        39,250 |
|              |  └ mlp (MLP)            | b: f32[50]      |             |               |
+--------------+-------------------------+-----------------+-------------+---------------+
| f32[500,50]  | mlp/~/linear_1 (Linear) | w: f32[50,10]   | f32[500,10] |           510 |
|              |  └ mlp (MLP)            | b: f32[10]      |             |               |
+--------------+-------------------------+-----------------+-------------+---------------+
+---------------------------------------------+---------+-------------+
| Params                                      | State   | Callbacks   |
+=============================================+=========+=============+
| mlp/~/linear_0:                             | {}      | []          |
|   b: all_zeros                              |         |             |
|   w: x∈[-0.071, 0.071] μ=-9.844e-05 σ=0.032 |         |             |
| mlp/~/linear_1:                             |         |             |
|   b: all_zeros                              |         |             |
|   w: x∈[-0.275, 0.279] μ=-0.002 σ=0.123     |         |             |
+---------------------------------------------+---------+-------------+</code></pre>
</div>
</div>
<p>A <code>callback</code> is any <code>Callable</code> that you pass on <code>subscribe</code>.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="23">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>u1 <span class="op">=</span> ms.subscribe(<span class="kw">lambda</span> x: <span class="bu">print</span>(<span class="st">"1: callback 1"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1: callback 1</code></pre>
</div>
</div>
<p>A change in the store value, triggers all callbacks subscribed to it.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="24">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> ms.get()</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>ms.<span class="bu">set</span>(Model(<span class="op">**</span>(m._asdict()<span class="op">|</span>{<span class="st">"state"</span>: {<span class="st">'a'</span>: <span class="dv">1</span>, <span class="st">'b'</span>: <span class="dv">2</span>}})))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1: callback 1</code></pre>
</div>
</div>
</section>
<section id="optimizer" class="level4">
<h4 class="anchored" data-anchor-id="optimizer">Optimizer</h4>
<p>You can have different <code>stores</code> for different things. For example, this is a simpler one to deal with the optimizer.</p>
<hr>
<p><a href="https://github.com/fredguth/reax/blob/main/reax/core.py#L104" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
</section>
<section id="optimizer-1" class="level3">
<h3 class="anchored" data-anchor-id="optimizer-1">Optimizer</h3>
<blockquote class="blockquote">
<pre><code> Optimizer (state:Union[jax.Array,Iterable[ForwardRef('ArrayTree')],Mappin
            g[Any,ForwardRef('ArrayTree')]], apply:Callable)</code></pre>
</blockquote>
<p>By the way, we will use <a href="https://optax.readthedocs.io/">Optax</a>, which is a good companion for <code>Haiku</code>.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="26">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>grad_tfm <span class="op">=</span> optax.sgd(<span class="fl">1e-3</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="bu">apply</span> <span class="op">=</span> grad_tfm.update</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>optState <span class="op">=</span> grad_tfm.init(m.params) <span class="co"># you initialize the optimizer with the model params</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> Optimizer(state<span class="op">=</span>optState, <span class="bu">apply</span><span class="op">=</span><span class="bu">apply</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>optimizer</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>Optimizer(state=(EmptyState(), EmptyState()), apply=&lt;function chain.&lt;locals&gt;.update_fn at 0x7f512c6ab280&gt;)</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="27">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>os<span class="op">=</span> OptimizerStore(optimizer)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>u2 <span class="op">=</span> os.subscribe(<span class="kw">lambda</span> x: <span class="bu">print</span>(<span class="ss">f"callback 2: </span><span class="sc">{</span>x<span class="sc">}</span><span class="ss">"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>callback 2: Optimizer(state=(EmptyState(), EmptyState()), apply=&lt;function chain.&lt;locals&gt;.update_fn at 0x7f512c6ab280&gt;)</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="28">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>grad_tf2 <span class="op">=</span> optax.adam(<span class="fl">1e-4</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>optState2 <span class="op">=</span> grad_tf2.init(m.params)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>os.<span class="bu">set</span>(Optimizer(state<span class="op">=</span>optState2, <span class="bu">apply</span><span class="op">=</span>grad_tf2.update))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>callback 2: Optimizer(state=(ScaleByAdamState(count=Array i32 gpu:0 0, mu={'mlp/~/linear_0': {'b': Array[50] all_zeros gpu:0, 'w': Array[784, 50] all_zeros gpu:0}, 'mlp/~/linear_1': {'b': Array[10] all_zeros gpu:0 [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.], 'w': Array[50, 10] all_zeros gpu:0}}, nu={'mlp/~/linear_0': {'b': Array[50] all_zeros gpu:0, 'w': Array[784, 50] all_zeros gpu:0}, 'mlp/~/linear_1': {'b': Array[10] all_zeros gpu:0 [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.], 'w': Array[50, 10] all_zeros gpu:0}}), EmptyState()), apply=&lt;function chain.&lt;locals&gt;.update_fn at 0x7f512c6abca0&gt;)</code></pre>
</div>
</div>
<p>Cleaning up… you should remember to unsubscribe when you are done with a store.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="29">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>u1(), u2()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>(None, None)</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="30">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> Model.from_haiku(transformed<span class="op">=</span>network, x<span class="op">=</span>batch.<span class="bu">input</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>ms <span class="op">=</span> ModelStore(m)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>u1 <span class="op">=</span> ms.subscribe(<span class="kw">lambda</span> x: <span class="bu">print</span>(<span class="ss">f"cb 1:</span><span class="ch">\n</span><span class="sc">{</span>x<span class="sc">}</span><span class="ss">"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>cb 1:
+--------------+-------------------------+-----------------+-------------+---------------+
| Input        | Module                  | Module params   | Output      |   Param count |
+==============+=========================+=================+=============+===============+
| f32[500,784] | mlp (MLP)               |                 | f32[500,10] |        39,760 |
+--------------+-------------------------+-----------------+-------------+---------------+
| f32[500,784] | mlp/~/linear_0 (Linear) | w: f32[784,50]  | f32[500,50] |        39,250 |
|              |  └ mlp (MLP)            | b: f32[50]      |             |               |
+--------------+-------------------------+-----------------+-------------+---------------+
| f32[500,50]  | mlp/~/linear_1 (Linear) | w: f32[50,10]   | f32[500,10] |           510 |
|              |  └ mlp (MLP)            | b: f32[10]      |             |               |
+--------------+-------------------------+-----------------+-------------+---------------+
+-----------------------------------------+---------+
| Params                                  | State   |
+=========================================+=========+
| mlp/~/linear_0:                         | {}      |
|   b: all_zeros                          |         |
|   w: x∈[-0.071, 0.071] μ=-0.000 σ=0.032 |         |
| mlp/~/linear_1:                         |         |
|   b: all_zeros                          |         |
|   w: x∈[-0.280, 0.278] μ=-0.008 σ=0.123 |         |
+-----------------------------------------+---------+</code></pre>
</div>
</div>
</section>
</section>
<section id="training" class="level2">
<h2 class="anchored" data-anchor-id="training">Training</h2>
<p>Finally we arrived at the Training, the <code>core</code> of the <code>core</code> <code>¯\_(ツ)_/¯</code></p>
<p>Here is where we will most need callbacks.</p>
<section id="learner" class="level4">
<h4 class="anchored" data-anchor-id="learner">Learner</h4>
<p>Like in <code>fastai</code>, we create a <a href="https://fredguth.github.io/reax/core.html#learner"><code>Learner</code></a> class that will deal with the training.</p>
<hr>
<p><a href="https://github.com/fredguth/reax/blob/main/reax/core.py#L112" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="learner-1" class="level3">
<h3 class="anchored" data-anchor-id="learner-1">Learner</h3>
<blockquote class="blockquote">
<pre><code> Learner (model:__main__.ModelStore, dls:reax.data.DataLoaders, loss_func:
          Callable[[Union[jax.Array,numpy.ndarray],Union[jax.Array,numpy.n
          darray]],Union[jax.Array,numpy.ndarray]],
          optimizer:reax.stores.Writable[__main__.Optimizer])</code></pre>
</blockquote>
<p>Basic class for handling the training loop.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="32">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>learner <span class="op">=</span> Learner(model<span class="op">=</span>ms, dls<span class="op">=</span>dls, loss_func<span class="op">=</span>optax.softmax_cross_entropy_with_integer_labels, optimizer<span class="op">=</span>os)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>learner</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>Learner:
+-----------------+-----------------+-----------------+-----------------+
|           Model |     DataLoaders |          LossFn |       Optimizer |
+=================+=================+=================+=================+
| 139986614063552 | 139987146199584 | 139990720158448 | 139986614065904 |
+-----------------+-----------------+-----------------+-----------------+</code></pre>
</div>
</div>
<p>Learner itself, is not a store, but holds different stores for different aspects of the training.</p>
<p>We have a <a href="https://fredguth.github.io/reax/core.html#modelstore"><code>ModelStore</code></a>, an <code>OptimizerStore</code>… it is only missing the most important thing we want to <strong>observe</strong>… the training loop itself. We need a <a href="https://fredguth.github.io/reax/core.html#trainingstore"><code>TrainingStore</code></a>.</p>
<p>But for that… let’s first examine what we need. Let’s take a look in the <strong>training loop</strong>:</p>
<section id="the-anatomy-of-a-training-loop" class="level4">
<h4 class="anchored" data-anchor-id="the-anatomy-of-a-training-loop">The anatomy of a training loop</h4>
<div class="sourceCode" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pseudo-code</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fit(epochs: <span class="bu">int</span>)<span class="op">-&gt;</span><span class="va">None</span>:</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''Train the model for a number of epochs.'''</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># before fit</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(epochs):</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># is_training</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>        one_epoch(dls.train) <span class="co"># train for one epoch</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># is_validating</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>        one_epoch(dls.valid) <span class="co"># validate for one epoch</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># should halt epochs?</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># after fit</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> one_epoch(dl)<span class="op">-&gt;</span><span class="va">None</span>:</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''Train or validate for one epoch.'''</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># before epoch</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> batch_n, batch <span class="kw">in</span> <span class="bu">enumerate</span>(dl): </span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>        one_batch(batch_n, batch)</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># should halt batches?</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># after epoch</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> one_batch(batch_n: <span class="bu">int</span>, batch: Batch)<span class="op">-&gt;</span><span class="va">None</span>:</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''Train or validate for one batch.'''</span></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># before batch</span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>    predict(...) <span class="co"># preds</span></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>    evaluate(...)<span class="co"># loss</span></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>    update model(...) <span class="cf">if</span> is_training</span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># after batch</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Our <a href="https://fredguth.github.io/reax/core.html#trainingstore"><code>TrainingStore</code></a> shall tell us where we are in the training loop and some information relevant at this point.</p>
<blockquote class="blockquote">
<p>I am <code>training</code>, <code>epoch</code> 5, <code>iteration</code> 345, after <code>evaluate</code> with certain <code>current loss</code>.</p>
</blockquote>
<p>Another aspect is that it seems it should be a <a href="https://fredguth.github.io/reax/stores.html#readable"><code>Readable</code></a> store, afterall, we don’t want any callback being able to change information like: <code>in which batch of which epoch am I?</code></p>
<p>Exceptionally, we want to tell the <a href="https://fredguth.github.io/reax/core.html#trainingstore"><code>TrainingStore</code></a> to halt.</p>
<p>Let’s start with:</p>
<hr>
<p><a href="https://github.com/fredguth/reax/blob/main/reax/core.py#L124" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
</section>
<section id="trainingstate" class="level3">
<h3 class="anchored" data-anchor-id="trainingstate">TrainingState</h3>
<blockquote class="blockquote">
<pre><code> TrainingState (epochs:int, epoch:int, step:int, iter:int,
                batch:Optional[reax.data.Batch], last:Dict=None,
                is_running:bool=False, is_training:bool=False,
                is_validating:bool=False, should_halt:bool=False)</code></pre>
</blockquote>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="34">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> TrainingState(epochs<span class="op">=</span><span class="dv">0</span>, epoch<span class="op">=</span><span class="dv">0</span>, step<span class="op">=</span><span class="dv">0</span>, <span class="bu">iter</span><span class="op">=</span><span class="dv">0</span>, batch<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>t</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>TrainingState:
-------------  -----
epochs             0
epoch              0
step               0
iter               0
batch
last
is_running     False
is_training    False
is_validating  False
should_halt    False
-------------  -----</code></pre>
</div>
</div>
</section>
<section id="training-store" class="level3">
<h3 class="anchored" data-anchor-id="training-store">Training Store</h3>
<hr>
<p><a href="https://github.com/fredguth/reax/blob/main/reax/core.py#L149" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="trainingstore" class="level3">
<h3 class="anchored" data-anchor-id="trainingstore">TrainingStore</h3>
<blockquote class="blockquote">
<pre><code> TrainingStore (initial_value:T, start:Notifier)</code></pre>
</blockquote>
<p>A store that keeps tracking of the training loop state</p>
<table class="table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>initial_value</td>
<td>T</td>
<td>initial value of the store</td>
</tr>
<tr class="even">
<td>start</td>
<td>Notifier</td>
<td>function called when the first subscriber is added</td>
</tr>
<tr class="odd">
<td><strong>Returns</strong></td>
<td><strong>None</strong></td>
<td></td>
</tr>
</tbody>
</table>
<section id="trainingstore-representation" class="level4">
<h4 class="anchored" data-anchor-id="trainingstore-representation">TrainingStore representation</h4>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="37">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># a = [("A", "B", "C"), (1,2,3)]</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co"># b = [("D", "E", None), (4,5,None)]</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> [(<span class="st">"A"</span>, <span class="dv">1</span>), [<span class="st">"B"</span>, <span class="dv">2</span>], [<span class="st">"C"</span>, <span class="dv">3</span>]]</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> [[<span class="st">"D"</span>, <span class="dv">4</span>], [<span class="st">"E"</span>, <span class="dv">5</span>]]</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> <span class="bu">list</span>(<span class="bu">zip</span>(<span class="op">*</span>a))</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> <span class="bu">list</span>(<span class="bu">zip</span>(<span class="op">*</span>b))</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> <span class="bu">list</span>(itertools.zip_longest(<span class="op">*</span>c,<span class="op">*</span>d))</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(table, headers<span class="op">=</span>[<span class="st">''</span>,<span class="st">'H1'</span>,<span class="st">''</span>, <span class="st">"H2"</span>], tablefmt<span class="op">=</span><span class="st">'grid'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+----+------+----+------+
|    |   H1 |    |   H2 |
+====+======+====+======+
| A  |    1 | D  |    4 |
+----+------+----+------+
| B  |    2 | E  |    5 |
+----+------+----+------+
| C  |    3 |    |      |
+----+------+----+------+</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="38">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> [[<span class="st">"A"</span>, <span class="dv">1</span>], [<span class="st">"B"</span>, <span class="dv">2</span>], [<span class="st">"C"</span>, <span class="dv">3</span>]]</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> []</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> <span class="bu">list</span>(<span class="bu">zip</span>(<span class="op">*</span>a))</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> <span class="bu">list</span>(<span class="bu">zip</span>(<span class="op">*</span>b))</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> <span class="bu">list</span>(itertools.zip_longest(<span class="op">*</span>c,<span class="op">*</span>d))</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(table, headers<span class="op">=</span>[<span class="st">''</span>,<span class="st">'H1'</span>,<span class="st">''</span>, <span class="st">"H2"</span>], tablefmt<span class="op">=</span><span class="st">'grid'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+----+------+
|    |   H1 |
+====+======+
| A  |    1 |
+----+------+
| B  |    2 |
+----+------+
| C  |    3 |
+----+------+</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="39">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> [(<span class="st">'epoch'</span>, <span class="dv">0</span>), (<span class="st">'step'</span>, <span class="dv">0</span>), (<span class="st">'batch_n'</span>, <span class="dv">0</span>), (<span class="st">'batch'</span>, <span class="va">None</span>), (<span class="st">'metrics'</span>, <span class="va">None</span>), (<span class="st">'last_event'</span>, <span class="va">None</span>), (<span class="st">'is_training'</span>, <span class="va">False</span>), (<span class="st">'should_halt'</span>, <span class="va">False</span>)]</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> [(<span class="st">'0:'</span>, <span class="kw">lambda</span>:<span class="va">None</span>)]</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> <span class="bu">list</span>(<span class="bu">zip</span>(<span class="op">*</span>a))</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> <span class="bu">list</span>(<span class="bu">zip</span>(<span class="op">*</span>b))</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> <span class="bu">list</span>(itertools.zip_longest(<span class="op">*</span>c,<span class="op">*</span>d))</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(table, headers<span class="op">=</span>[<span class="st">''</span>,<span class="st">'H1'</span>,<span class="st">''</span>, <span class="st">"H2"</span>], tablefmt<span class="op">=</span><span class="st">'grid'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+-------------+-------+----+---------------------------------------+
|             |    H1 |    | H2                                    |
+=============+=======+====+=======================================+
| epoch       |     0 | 0: | &lt;function &lt;lambda&gt; at 0x7f514c0ed820&gt; |
+-------------+-------+----+---------------------------------------+
| step        |     0 |    |                                       |
+-------------+-------+----+---------------------------------------+
| batch_n     |     0 |    |                                       |
+-------------+-------+----+---------------------------------------+
| batch       |       |    |                                       |
+-------------+-------+----+---------------------------------------+
| metrics     |       |    |                                       |
+-------------+-------+----+---------------------------------------+
| last_event  |       |    |                                       |
+-------------+-------+----+---------------------------------------+
| is_training | False |    |                                       |
+-------------+-------+----+---------------------------------------+
| should_halt | False |    |                                       |
+-------------+-------+----+---------------------------------------+</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="41">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>ts <span class="op">=</span> TrainingStore(t, <span class="kw">lambda</span> x:<span class="va">None</span>)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>u4 <span class="op">=</span> ts.subscribe(<span class="kw">lambda</span> x: <span class="bu">print</span>(<span class="ss">f"callback 4:</span><span class="ch">\n</span><span class="ss"> </span><span class="sc">{</span>x<span class="sc">}</span><span class="ss">"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>callback 4:
 -------------  -----
epochs             0
epoch              0
step               0
iter               0
batch
last
is_running     False
is_training    False
is_validating  False
should_halt    False
-------------  -----</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="42">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+---------------+---------+----+---------------------------------------+
|               |   State |    | Calbacks                              |
+===============+=========+====+=======================================+
| epochs        |       0 | 0: | &lt;function &lt;lambda&gt; at 0x7f512c3d5af0&gt; |
+---------------+---------+----+---------------------------------------+
| epoch         |       0 |    |                                       |
+---------------+---------+----+---------------------------------------+
| step          |       0 |    |                                       |
+---------------+---------+----+---------------------------------------+
| iter          |       0 |    |                                       |
+---------------+---------+----+---------------------------------------+
| batch         |         |    |                                       |
+---------------+---------+----+---------------------------------------+
| last          |         |    |                                       |
+---------------+---------+----+---------------------------------------+
| is_running    |   False |    |                                       |
+---------------+---------+----+---------------------------------------+
| is_training   |   False |    |                                       |
+---------------+---------+----+---------------------------------------+
| is_validating |   False |    |                                       |
+---------------+---------+----+---------------------------------------+
| should_halt   |   False |    |                                       |
+---------------+---------+----+---------------------------------------+</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="43">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>unsubs <span class="op">=</span> []</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">12</span>):</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    u <span class="op">=</span> ts.subscribe(<span class="kw">lambda</span> x: <span class="bu">print</span>(<span class="ss">f"callback: </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>))</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    unsubs.append(u)</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>ts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>callback: 0
callback: 1
callback: 2
callback: 3
callback: 4
callback: 5
callback: 6
callback: 7
callback: 8
callback: 9
callback: 10
callback: 11</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre><code>TrainingStore:
+---------------+---------+-----+---------------------------------------+
|               |   State |     | Calbacks                              |
+===============+=========+=====+=======================================+
| epochs        |       0 | 0:  | &lt;function &lt;lambda&gt; at 0x7f512c3f6430&gt; |
+---------------+---------+-----+---------------------------------------+
| epoch         |       0 | 1:  | &lt;function &lt;lambda&gt; at 0x7f512c3d5e50&gt; |
+---------------+---------+-----+---------------------------------------+
| step          |       0 | 2:  | &lt;function &lt;lambda&gt; at 0x7f512c3d5670&gt; |
+---------------+---------+-----+---------------------------------------+
| iter          |       0 | 3:  | &lt;function &lt;lambda&gt; at 0x7f512c3f6670&gt; |
+---------------+---------+-----+---------------------------------------+
| batch         |         | 4:  | &lt;function &lt;lambda&gt; at 0x7f512c3f60d0&gt; |
+---------------+---------+-----+---------------------------------------+
| last          |         | 5:  | &lt;function &lt;lambda&gt; at 0x7f512c3d5af0&gt; |
+---------------+---------+-----+---------------------------------------+
| is_running    |   False | 6:  | &lt;function &lt;lambda&gt; at 0x7f512c3f6310&gt; |
+---------------+---------+-----+---------------------------------------+
| is_training   |   False | 7:  | &lt;function &lt;lambda&gt; at 0x7f512c3d5d30&gt; |
+---------------+---------+-----+---------------------------------------+
| is_validating |   False | 8:  | &lt;function &lt;lambda&gt; at 0x7f512c3f6550&gt; |
+---------------+---------+-----+---------------------------------------+
| should_halt   |   False | 9:  | &lt;function &lt;lambda&gt; at 0x7f512c3d5160&gt; |
+---------------+---------+-----+---------------------------------------+
|               |         | 10: | &lt;function &lt;lambda&gt; at 0x7f512c3d5f70&gt; |
+---------------+---------+-----+---------------------------------------+
|               |         | 11: | &lt;function &lt;lambda&gt; at 0x7f512c3d5790&gt; |
+---------------+---------+-----+---------------------------------------+
|               |         | 12: | &lt;function &lt;lambda&gt; at 0x7f512c3f61f0&gt; |
+---------------+---------+-----+---------------------------------------+</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="44">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> u <span class="kw">in</span> unsubs: u()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="45">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> NamedTuple(<span class="st">"a"</span>, [(<span class="st">"n"</span>, <span class="bu">int</span>)])</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>a.n <span class="op">=</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="54">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>a.x <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class '__main__.a'&gt;</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="67">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Bunch:</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">__init__</span> <span class="op">=</span> <span class="kw">lambda</span> <span class="va">self</span>, <span class="op">**</span>kw: <span class="bu">setattr</span>(<span class="va">self</span>, <span class="st">'__dict__'</span>, kw)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__repr__</span>(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>__class__<span class="sc">.</span><span class="va">__name__</span><span class="sc">}</span><span class="ss">(</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>__dict__<span class="sc">!r}</span><span class="ss">)"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="68">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> Bunch(n<span class="op">=</span><span class="dv">2</span>,x<span class="op">=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="71">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>a.y<span class="op">=</span><span class="dv">10</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>a.<span class="bu">iter</span> <span class="op">=</span> <span class="dv">20</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="72">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>a</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="72">
<pre><code>Bunch({'n': 2, 'x': 4, 'y': 10, 'iter': 20})</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="113">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>a.__dict__<span class="op">|</span>{<span class="st">'y'</span>:<span class="dv">12</span>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="113">
<pre><code>{'n': 2, 'x': 4, 'y': 12, 'iter': 20, 'z': 30}</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="73">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="bu">setattr</span>(a, <span class="st">'z'</span>, <span class="dv">30</span>)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>a</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="73">
<pre><code>Bunch({'n': 2, 'x': 4, 'y': 10, 'iter': 20, 'z': 30})</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="163">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> with_interceptor:</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, nm): <span class="va">self</span>.nm <span class="op">=</span> nm</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, f):</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'intercepting....'</span>)</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(f)</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(f'args: {args}')</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(f'kwargs: {kwargs}')</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> f</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__setattr__</span>(<span class="va">self</span>, k,v) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'i.__setattr__:'</span>, (k,v))</span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__setattr__</span>(k,v)</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DummyCls:</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">@with_interceptor</span></span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> dummy_fn(<span class="va">self</span>, x):</span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'dummy'</span>)</span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> DummyCls()</span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a>a.dummy_fn()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>i.__setattr__: ('nm', &lt;function DummyCls.dummy_fn at 0x7f50e4388160&gt;)</code></pre>
</div>
<div class="cell-output cell-output-error">
<pre><code>TypeError: __call__() missing 1 required positional argument: 'f'</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="164">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_pretty(func):</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> inner(<span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"I got decorated"</span>)</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>        func(<span class="op">*</span>args, <span class="op">**</span>kwargs)</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> inner</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="at">@make_pretty</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ordinary(x):</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"I am ordinary"</span>)</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>ordinary(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>I got decorated
I am ordinary</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="182">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> make_pretty:</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, f):<span class="va">self</span>.f <span class="op">=</span> f</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, <span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.args <span class="op">=</span> <span class="bu">list</span>(args)</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.kwargs <span class="op">=</span> <span class="bu">dict</span>(kwargs)</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"I got decorated"</span>)</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.f(<span class="op">*</span>args, <span class="op">**</span>kwargs)</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__setattr__</span>(<span class="va">self</span>, k,v) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'intercepting:'</span>, (k,v))</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__setattr__</span>(k,v)</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a><span class="co">#     def inner(*args, **kwargs):</span></span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a><span class="co">#         print("I got decorated")</span></span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a><span class="co">#         func(*args, **kwargs)</span></span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a><span class="co">#     return inner</span></span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a><span class="at">@make_pretty</span></span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ordinary(x):</span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"I am ordinary "</span>, x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>intercepting: ('f', &lt;function ordinary at 0x7f50e43c0310&gt;)</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="183">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>ordinary(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>intercepting: ('args', [1])
intercepting: ('kwargs', {})
I got decorated
I am ordinary  3</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="155">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> dummyInterceptor:</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, nm): <span class="va">self</span>.nm <span class="op">=</span> nm</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, f):</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> _f(<span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>            f(<span class="op">*</span>args, <span class="op">**</span>kwargs)</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> _f</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__setattr__</span>(<span class="va">self</span>, k,v) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'intercepting:'</span>, (k,v))</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__setattr__</span>(k,v)</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a><span class="co"># def __call__(self, f):</span></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a><span class="co">#         def _f(o, *args, **kwargs):</span></span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a><span class="co">#             try:</span></span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a><span class="co">#                 o.callback(f'before_{self.nm}')</span></span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a><span class="co">#                 f(o, *args, **kwargs)</span></span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a><span class="co">#                 o.callback(f'after_{self.nm}')</span></span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a><span class="co">#             except globals()[f'Cancel{self.nm.title()}Exception']: pass</span></span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a><span class="co">#             finally: o.callback(f'cleanup_{self.nm}')</span></span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a><span class="co">#         return _f</span></span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a><span class="at">@dummyInterceptor</span></span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dummy(x):</span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> g():</span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> <span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>intercepting: ('nm', &lt;function dummy at 0x7f50e4412c10&gt;)</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="156">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>dummy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>TypeError: __call__() missing 1 required positional argument: 'f'</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="75">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> inspect</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="117">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>f.__code__.co_varnames</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="117">
<pre><code>('x', 'y', 'z', 'a', 'g', 'c', 'd')</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="121">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>f.__code__.co_varnames</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="121">
<pre><code>('x', 'y', 'z', 'a', 'g', 'c', 'd')</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="125">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>learner.__dict__</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="125">
<div class="ansi-escaped-output">

<pre>{'__stored_args__': {'model': ModelStore:
  +-----------------------------------------+---------+--------------------------------------------+
  | Params                                  | State   | Callbacks                                  |
  +=========================================+=========+============================================+
  | mlp/~/linear_0:                         | {}      | - 0: &lt;function &lt;lambda&gt; at 0x7f512c6abf70&gt; |
  |   b: all_zeros                          |         |                                            |
  |   w: x∈[-0.071, 0.071] μ=-0.000 σ=0.032 |         |                                            |
  | mlp/~/linear_1:                         |         |                                            |
  |   b: all_zeros                          |         |                                            |
  |   w: x∈[-0.280, 0.278] μ=-0.008 σ=0.123 |         |                                            |
  +-----------------------------------------+---------+--------------------------------------------+,
  'dls': &lt;reax.data.DataLoaders at 0x7f514c1f5220&gt;,
  'loss_func': &lt;function optax._src.loss.softmax_cross_entropy_with_integer_labels(logits: jax.Array, labels: jax.Array) -&gt; jax.Array&gt;,
  'optimizer': Writable(Optimizer(state=(ScaleByAdamState(count=Array i32 gpu:0 0, mu={'mlp/~/linear_0': {'b': Array[50] <span style="color:rgb(127,127,127)">all_zeros</span> gpu:0, 'w': Array[784, 50] <span style="color:rgb(127,127,127)">all_zeros</span> gpu:0}, 'mlp/~/linear_1': {'b': Array[10] <span style="color:rgb(127,127,127)">all_zeros</span> gpu:0 [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.], 'w': Array[50, 10] <span style="color:rgb(127,127,127)">all_zeros</span> gpu:0}}, nu={'mlp/~/linear_0': {'b': Array[50] <span style="color:rgb(127,127,127)">all_zeros</span> gpu:0, 'w': Array[784, 50] <span style="color:rgb(127,127,127)">all_zeros</span> gpu:0}, 'mlp/~/linear_1': {'b': Array[10] <span style="color:rgb(127,127,127)">all_zeros</span> gpu:0 [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.], 'w': Array[50, 10] <span style="color:rgb(127,127,127)">all_zeros</span> gpu:0}}), EmptyState()), apply=&lt;function chain.&lt;locals&gt;.update_fn at 0x7f512c6abca0&gt;))},
 'model': ModelStore:
 +-----------------------------------------+---------+--------------------------------------------+
 | Params                                  | State   | Callbacks                                  |
 +=========================================+=========+============================================+
 | mlp/~/linear_0:                         | {}      | - 0: &lt;function &lt;lambda&gt; at 0x7f512c6abf70&gt; |
 |   b: all_zeros                          |         |                                            |
 |   w: x∈[-0.071, 0.071] μ=-0.000 σ=0.032 |         |                                            |
 | mlp/~/linear_1:                         |         |                                            |
 |   b: all_zeros                          |         |                                            |
 |   w: x∈[-0.280, 0.278] μ=-0.008 σ=0.123 |         |                                            |
 +-----------------------------------------+---------+--------------------------------------------+,
 'dls': &lt;reax.data.DataLoaders at 0x7f514c1f5220&gt;,
 'loss_func': &lt;function optax._src.loss.softmax_cross_entropy_with_integer_labels(logits: jax.Array, labels: jax.Array) -&gt; jax.Array&gt;,
 'optimizer': Writable(Optimizer(state=(ScaleByAdamState(count=Array i32 gpu:0 0, mu={'mlp/~/linear_0': {'b': Array[50] <span style="color:rgb(127,127,127)">all_zeros</span> gpu:0, 'w': Array[784, 50] <span style="color:rgb(127,127,127)">all_zeros</span> gpu:0}, 'mlp/~/linear_1': {'b': Array[10] <span style="color:rgb(127,127,127)">all_zeros</span> gpu:0 [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.], 'w': Array[50, 10] <span style="color:rgb(127,127,127)">all_zeros</span> gpu:0}}, nu={'mlp/~/linear_0': {'b': Array[50] <span style="color:rgb(127,127,127)">all_zeros</span> gpu:0, 'w': Array[784, 50] <span style="color:rgb(127,127,127)">all_zeros</span> gpu:0}, 'mlp/~/linear_1': {'b': Array[10] <span style="color:rgb(127,127,127)">all_zeros</span> gpu:0 [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.], 'w': Array[50, 10] <span style="color:rgb(127,127,127)">all_zeros</span> gpu:0}}), EmptyState()), apply=&lt;function chain.&lt;locals&gt;.update_fn at 0x7f512c6abca0&gt;))}</pre>
</div>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="127">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="127">
<pre><code>'__main__'</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}" data-execution_count="111">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="at">@fc.patch</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__getattr__</span>(<span class="va">self</span>:Learner, name):</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> name <span class="kw">in</span> (<span class="st">'epochs'</span>,<span class="st">'epoch'</span>,<span class="st">'iter'</span>,<span class="st">'one_batch'</span>): </span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> partial(<span class="va">self</span>.callback, name)</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">AttributeError</span>(name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>AttributeError: 'Learner' object has no attribute 'getattrs'</code></pre>
</div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> with_cbs:</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, nm): <span class="va">self</span>.nm <span class="op">=</span> nm</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, f):</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> _f(o, <span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>                o.callback(<span class="ss">f'before_</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>nm<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>                f(o, <span class="op">*</span>args, <span class="op">**</span>kwargs)</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>                o.callback(<span class="ss">f'after_</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>nm<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="bu">globals</span>()[<span class="ss">f'Cancel</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>nm<span class="sc">.</span>title()<span class="sc">}</span><span class="ss">Exception'</span>]: <span class="cf">pass</span></span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">finally</span>: o.callback(<span class="ss">f'cleanup_</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>nm<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> _f</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;python&quot;}">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> callback(<span class="va">self</span>, method_nm): </span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>    run_cbs(<span class="va">self</span>.cbs, method_nm, <span class="va">self</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Copyright 2023, Fred Guth</div>   
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://nbdev.fast.ai">Built with <code>nbdev</code></a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/fredguth/reax">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>